generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  RESELLER
}

enum TransactionType {
  DEPOSIT
  SPEND
  REFUND
  CREDIT_IN
  CREDIT_OUT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum PaymentStatus {
  PENDING
  PAID
  CANCELED
}

model Tenant {
  id                    String        @id @default(uuid()) @db.Uuid
  name                  String
  slug                  String        @unique
  brandColor            String?       @map("brand_color")
  logoUrl               String?       @map("logo_url")
  warezUsername         String?       @map("warez_username")
  warezPassword         String?       @map("warez_password")
  monnifyToken          String?       @map("monnify_token")
  monnifyWebhookSecret  String?       @map("monnify_webhook_secret")
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  users                 User[]
  products              Product[]
  orders                Order[]
  transactions          Transaction[]
  externalLogs          ExternalLog[]

  @@map("tenants")
}

model User {
  id           String        @id @default(uuid()) @db.Uuid
  tenantId     String        @map("tenant_id") @db.Uuid
  name         String
  email        String
  passwordHash String        @map("password_hash")
  role         UserRole      @default(RESELLER)
  balance      Decimal       @default(0)
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  orders       Order[]
  transactions Transaction[]

  @@unique([tenantId, email])
  @@map("users")
}

model Product {
  id             String    @id @default(uuid()) @db.Uuid
  tenantId       String    @map("tenant_id") @db.Uuid
  name           String
  price          Decimal
  creditsAmount  Int       @map("credits_amount")
  active         Boolean   @default(true)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  tenant         Tenant    @relation(fields: [tenantId], references: [id])
  orders         Order[]

  @@map("products")
}

model Order {
  id          String        @id @default(uuid()) @db.Uuid
  tenantId    String        @map("tenant_id") @db.Uuid
  userId      String        @map("user_id") @db.Uuid
  productId   String        @map("product_id") @db.Uuid
  totalAmount Decimal       @map("total_amount")
  paymentId   String?       @map("payment_id")
  status      PaymentStatus @default(PENDING)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  tenant      Tenant        @relation(fields: [tenantId], references: [id])
  user        User          @relation(fields: [userId], references: [id])
  product     Product       @relation(fields: [productId], references: [id])
  transactions Transaction[]

  @@map("orders")
}

model Transaction {
  id          String            @id @default(uuid()) @db.Uuid
  tenantId    String            @map("tenant_id") @db.Uuid
  userId      String            @map("user_id") @db.Uuid
  orderId     String?           @map("order_id") @db.Uuid
  type        TransactionType
  amount      Decimal
  description String?
  status      TransactionStatus @default(PENDING)
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  tenant      Tenant            @relation(fields: [tenantId], references: [id])
  user        User              @relation(fields: [userId], references: [id])
  order       Order?            @relation(fields: [orderId], references: [id])

  @@map("transactions")
}

model ExternalLog {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String?  @map("tenant_id") @db.Uuid
  endpoint       String
  requestPayload Json     @map("request_payload")
  responseData   Json?    @map("response_data")
  statusCode     Int?     @map("status_code")
  createdAt      DateTime @default(now()) @map("created_at")

  tenant         Tenant?  @relation(fields: [tenantId], references: [id])

  @@map("external_logs")
}
